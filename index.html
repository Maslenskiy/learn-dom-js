<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <p id="loader">Коментарий загружается...</p>
      <ul class="comments" id="coment-list">
        // Этот список рендерится из js
      </ul>
      <div class="add-form">
        <input id="nameInput"
          value=""
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea id="textInput"
          value=""
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button" id="add-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
  <style>
    .error{
      background-color: red;
    }
  </style>
  <script>
    "use strict";
  const addButtonElement = document.getElementById("add-button");
  const comentListElement = document.getElementById("coment-list");
  const nameInputElement = document.getElementById("nameInput");
  const textInputElement = document.getElementById("textInput");
  const loaderElement = document.getElementById("loader");
  function getCurrentDateTime() {
    const now = new Date();
    const year = now.getFullYear().toString().slice(-2).padStart(2, '0'); // Получаем последние две цифры года
    const month = (now.getMonth() + 1).toString().padStart(2, '0'); // Месяц начинается с 0
    const day = now.getDate().toString().padStart(2, '0');
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    
    return `${day}.${month}.${year} ${hours}:${minutes}`;
}
  
//Api запрос на серввер на получение коментариев
function getComents (){
   return fetch("https://wedev-api.sky.pro/api/v1/maslenskiy-yuriyyy/comments",
{
  method:"GET"
})
.then((response)=>{
  return response.json(); 
})
.then((responseData)=>{
  const appComments = responseData.comments.map((comment)=>{
      return{
        name:comment.author.name,
        date: new Date(comment.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'numeric', year: 'numeric', hour: 'numeric', minute: 'numeric', hour12: false }).replace(',', ''),
        text:comment.text,
        likeCounter:comment.likes,
        isLiked: false,
      };
    });
    coments = appComments;
    renderComents ()
    loaderElement.style.display = 'none'
})
}
loaderElement.style.display = 'Block'
getComents ()




let coments = []

function renderComents (){
 const listHtml = coments.map((coment, index)=>{
    return `<li class="comment">
          <div class="comment-header">
            <div>${coment.name}</div>
            <div>${coment.date}</div>
          </div>
          <div class="comment-body">
            <div class="comment-text">
              ${coment.text}
            </div>
          </div>
          <div class="comment-footer">
            <button id="delete-form-button" class="delete-form-button" data-index="${index}">Удалить</button>
            <div class="likes">
              <span class="likes-counter">${coment.likeCounter}</span>
              <button class="like-button ${coment.isLiked ? "-active-like" : ""}" data-index="${index}"></button>
            </div>
          </div>
        </li>`
  }).join("");
  comentListElement.innerHTML = listHtml;
  initLikeListener()
  initDeleteListeners()
  initCommentClickListeners();
}
renderComents()

// функционал коментирования
function initCommentClickListeners() {
    const commentElements = document.querySelectorAll('.comment');
    commentElements.forEach(comment => {
        comment.addEventListener('click', (event) => {
            event.stopPropagation(); // Предотвращаем всплытие события
            const text = comment.querySelector('.comment-text').textContent.trim();
            nameInputElement.value = ""; // Поле для имени очищается
            textInputElement.value = text;
        });
    });
}


//Активность кнопки удаления
function initDeleteListeners(){
  const deleteButtonElement = document.querySelectorAll(".delete-form-button");
  for(const deleteItem of deleteButtonElement){
    deleteItem.addEventListener("click", ()=>{
      event.stopPropagation();
        const index = deleteItem.dataset.index;
        coments.splice(index, 1);
        renderComents();
    })
  }
}
//Активность кнопки лайк
function initLikeListener(){
  const likeButtonElement = document.querySelectorAll(".like-button");
  for(const like of likeButtonElement){
    like.addEventListener("click", (event)=>{
      event.stopPropagation();
      const index = like.dataset.index;
      coments[index].likeCounter += coments[index].isLiked ? -1 : +1;
      coments[index].isLiked = !coments[index].isLiked;
      renderComents ()
    })
  }
}


  addButtonElement.addEventListener("click", ()=>{
    nameInputElement.classList.remove("error")
    textInputElement.classList.remove("error")
    if(nameInputElement.value === "" || textInputElement.value === ""){
      nameInputElement.classList.add("error")
      textInputElement.classList.add("error");
      return
    } 
    addButtonElement.disabled = true;
    addButtonElement.textContent = "Отправляю коментарий...";
    loaderElement.style.display = 'none'
  fetch("https://wedev-api.sky.pro/api/v1/maslenskiy-yuriyyy/comments",
{
  method:"POST",
  body: JSON.stringify({
    name:nameInputElement.value.replaceAll("<", "&lt").replaceAll(">", "&gt"),
    date:getCurrentDateTime(),
    text:textInputElement.value.replaceAll("<", "&lt").replaceAll(">", "&gt"),
    likeCounter: 0,
    forceError: false,
  })
})
.then((response)=>{
  if(response.status === 201){
    return response.json();
  }
  if(response.status === 400){
    throw new Error("Имя и текст коментария должны быть больше 3 символов")
    console.log(response)
  }
  if(response.status === 500){
    throw new Error("Сервер сломался")
  }
})
.then((responseData)=>{
  return getComents ()
})
.then((data)=>{
  addButtonElement.disabled = false;
  addButtonElement.textContent = "Отправить";
  nameInputElement.value = "";
  textInputElement.value = "";
})
.catch((error)=>{
  addButtonElement.disabled = false;
  addButtonElement.textContent = "Отправить";
  if(error.message === "Имя и текст коментария должны быть больше 3 символов"){
    alert("Имя и текст коментария должны быть не менее 3 символов")
  }
  if(error.message === "Сервер сломался"){
    alert("Извините сервер упал, попробуйте позже")
  }

})
  
    renderComents ()
  })
  </script>
</html>
